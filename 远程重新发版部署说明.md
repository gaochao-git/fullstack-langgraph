# 远程重新发版部署说明

## 📋 部署流程概览

```
本地开发 → 本地打包 → 上传远程 → 自动升级 ✨
```

## 🚀 快速升级流程（推荐）

### 1. 本地操作

```bash
# 本地开发和测试
make dev

# 构建生产部署包
make build

# 上传到远程服务器
make deploy
```

### 2. 远程一键升级

```bash
# 连接到远程服务器
ssh root@82.156.146.51

# 一键自动升级（推荐）
cd /data/langgraph_prd
./upgrade.sh fullstack-langgraph-YYYYMMDD_HHMMSS

# 输出示例：
# ✅ 🎉 升级完成！
# ℹ️  服务信息:
#   版本: fullstack-langgraph-20250721_064415
#   PID: 29133
#   访问地址: http://localhost:8000
```

### 3. 升级选项

```bash
# 标准升级（自动备份）
./upgrade.sh package_name

# 快速升级（跳过备份）
./upgrade.sh package_name --no-backup

# 强制升级（忽略警告）
./upgrade.sh package_name --force

# 查看帮助
./upgrade.sh --help
```

## 🛠️ 手动升级流程（备用）

### 1. 本地开发和测试

```bash
# 启动本地开发环境
make dev

# 测试功能是否正常
# 访问 http://localhost:3000 (前端)
# 访问 http://localhost:8000 (后端API)
```

### 2. 本地构建发版包

```bash
# 构建生产部署包
make build

# 输出示例：
# 📦 部署包位置: production_build/fullstack-langgraph-20250720_221936.tar.gz
```

### 3. 上传到远程服务器

```bash
# 上传部署包到远程服务器
make deploy

# 输出示例：
# ✅ Successfully deployed to root@82.156.146.51:/tmp/fullstack-langgraph-20250720_221936.tar.gz
```

### 4. 远程服务器手动部署

#### 4.1 连接到远程服务器

```bash
ssh root@82.156.146.51
```

#### 4.2 解压新版本文件

```bash
# 进入临时目录
cd /tmp

# 解压最新的部署包
tar -xzf fullstack-langgraph-*.tar.gz

# 查看解压的目录
ls -la fullstack-langgraph-*/
```

#### 4.3 停止当前服务

```bash
# 进入生产部署目录
cd /data/langgraph_prd

# 停止当前服务
./stop.sh
```

#### 4.4 备份当前版本（可选）

```bash
# 备份当前版本（可选）
cd /data
cp -r langgraph_prd langgraph_prd_backup_$(date +%Y%m%d_%H%M%S)
```

#### 4.5 更新代码文件

```bash
# 返回临时目录
cd /tmp/fullstack-langgraph-*

# 复制新版本文件到生产目录（保留venv）
cp -r backend /data/langgraph_prd/
cp -r frontend_dist /data/langgraph_prd/
cp *.sh /data/langgraph_prd/
cp nginx.conf /data/langgraph_prd/
cp *.md /data/langgraph_prd/

# 设置脚本执行权限
cd /data/langgraph_prd
chmod +x *.sh
```

#### 4.6 更新Python依赖（如有变化）

```bash
# 如果requirements.txt有更新，需要重新安装依赖
cd /data/langgraph_prd
source venv/bin/activate
pip install -r backend/requirements.txt
```

#### 4.7 启动新版本服务

```bash
# 启动服务
./start.sh

# 输出示例：
# ✅ 服务已启动 (PID: 12345)
# 🌐 访问地址: http://localhost:8000
```

## 🔍 验证部署结果

### 检查服务状态

```bash
# 检查进程是否运行
ps aux | grep gunicorn

# 检查端口是否监听
netstat -tlnp | grep :8000

# 查看实时日志
tail -f /data/langgraph_prd/access.log
tail -f /data/langgraph_prd/error.log
```

### 测试服务功能

```bash
# 测试API是否响应
curl -I http://localhost:8000/

# 如果配置了nginx，测试前端页面
curl -I http://82.156.146.51/
```

## 🎯 升级脚本功能详解

### upgrade.sh 自动化功能

upgrade.sh 脚本会自动执行以下8个步骤：

1. **环境检查** - 验证部署目录和安装包
2. **服务状态检查** - 检测当前服务运行状态
3. **解压新版本** - 自动解压部署包
4. **备份当前版本** - 自动备份（可选 `--no-backup`）
5. **停止当前服务** - 优雅停止服务
6. **更新文件** - 替换代码、脚本、配置文件
7. **更新依赖** - 智能检测并更新Python包
8. **启动新服务** - 启动并验证新版本

### 升级脚本优势

- ✅ **一键升级** - 单条命令完成所有操作
- ✅ **零停机** - 快速切换，最小化服务中断
- ✅ **安全可靠** - 多重检查，自动备份
- ✅ **智能依赖** - 只在有变化时更新依赖
- ✅ **状态验证** - 确认新服务运行正常
- ✅ **回滚准备** - 提供完整回滚命令

### 升级脚本输出示例

```bash
$ ./upgrade.sh fullstack-langgraph-20250721_064415

ℹ️  开始升级服务到版本: fullstack-langgraph-20250721_064415

ℹ️  步骤 1/8: 检查当前环境...
✅ 环境检查通过

ℹ️  步骤 2/8: 检查当前服务状态...
ℹ️  检测到服务正在运行 (PID: 25435)

ℹ️  步骤 3/8: 解压新版本文件...
✅ 解压完成

ℹ️  步骤 4/8: 备份当前版本...
✅ 备份完成: /data/langgraph_prd_backup_20250721_064558

ℹ️  步骤 5/8: 停止当前服务...
✅ 服务已停止

ℹ️  步骤 6/8: 更新应用文件...
✅ 文件更新完成

ℹ️  步骤 7/8: 检查并更新Python依赖...
ℹ️  依赖无变化，跳过更新

ℹ️  步骤 8/8: 启动新版本服务...
✅ 新版本服务启动成功 (PID: 29133)

✅ 🎉 升级完成！

ℹ️  服务信息:
  版本: fullstack-langgraph-20250721_064415
  PID: 29133
  访问地址: http://localhost:8000

ℹ️  回滚方法 (如果需要):
  cd /data && rm -rf langgraph_prd && mv langgraph_prd_backup_20250721_064558 langgraph_prd && cd langgraph_prd && ./start.sh
```

## 🚨 故障排除

### 问题1：服务启动失败

```bash
# 查看错误日志
cat /data/langgraph_prd/error.log

# 检查虚拟环境
source /data/langgraph_prd/venv/bin/activate
python --version
pip list | grep -E "(fastapi|uvicorn|gunicorn)"

# 手动测试启动
cd /data/langgraph_prd/backend
python -m src.api.app
```

### 问题2：依赖包问题

```bash
# 重新安装依赖
cd /data/langgraph_prd
source venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt
```

### 问题3：权限问题

```bash
# 检查文件权限
ls -la /data/langgraph_prd/
chmod +x /data/langgraph_prd/*.sh
```

### 问题4：端口被占用

```bash
# 查看端口占用
lsof -i :8000
netstat -tlnp | grep :8000

# 强制杀死进程
sudo fuser -k 8000/tcp
```

## 🔄 回滚操作

### 自动回滚（推荐）

升级脚本会自动提供回滚命令：

```bash
# upgrade.sh 输出的回滚命令示例：
cd /data && rm -rf langgraph_prd && mv langgraph_prd_backup_20250721_064558 langgraph_prd && cd langgraph_prd && ./start.sh
```

### 手动回滚

如果需要手动回滚：

```bash
# 停止当前服务
cd /data/langgraph_prd
./stop.sh

# 恢复备份版本
cd /data
rm -rf langgraph_prd
mv langgraph_prd_backup_YYYYMMDD_HHMMSS langgraph_prd

# 启动备份版本
cd /data/langgraph_prd
./start.sh
```

## 📝 操作检查清单

### 快速升级清单（推荐）

- [ ] 本地功能测试通过
- [ ] 执行 `make build` 构建成功
- [ ] 执行 `make deploy` 上传成功
- [ ] SSH连接到远程服务器
- [ ] 执行 `./upgrade.sh package_name`
- [ ] 验证升级输出正常
- [ ] 测试主要功能

### 手动升级清单（备用）

- [ ] 本地功能测试通过
- [ ] 执行 `make build` 构建成功
- [ ] 执行 `make deploy` 上传成功
- [ ] SSH连接到远程服务器
- [ ] 解压新版本文件
- [ ] 停止当前服务
- [ ] 备份当前版本（可选）
- [ ] 复制新版本文件
- [ ] 更新依赖包（如需要）
- [ ] 启动新版本服务
- [ ] 验证服务运行正常
- [ ] 测试主要功能
- [ ] 清理临时文件

## 🎯 升级流程对比

| 操作 | 手动升级 | 自动升级 (upgrade.sh) |
|------|----------|----------------------|
| 停止服务 | 手动执行 | ✅ 自动执行 |
| 备份版本 | 手动执行 | ✅ 自动执行 |
| 解压文件 | 手动执行 | ✅ 自动执行 |
| 更新文件 | 手动复制 | ✅ 自动更新 |
| 更新依赖 | 手动检查 | ✅ 智能检测 |
| 启动服务 | 手动执行 | ✅ 自动启动 |
| 状态验证 | 手动检查 | ✅ 自动验证 |
| 回滚准备 | 手动记录 | ✅ 自动提供 |
| 执行时间 | ~10分钟 | ~2分钟 |
| 出错风险 | 较高 | 极低 |

## 💡 最佳实践

### 升级建议

1. **优先使用自动升级** - upgrade.sh 脚本更安全可靠
2. **保留备份** - 不要使用 `--no-backup` 选项（除非磁盘空间不足）
3. **验证功能** - 升级后测试关键功能
4. **清理备份** - 定期清理旧的备份文件

### 安全提示

- ✅ 升级前确保有足够的磁盘空间
- ✅ 在低峰期进行升级操作
- ✅ 升级后立即验证核心功能
- ✅ 保持最近3个版本的备份

### 紧急情况处理

如果升级过程中断或失败：

```bash
# 1. 检查服务状态
ps aux | grep gunicorn

# 2. 查看升级日志
ls -la /data/langgraph_prd_backup_*

# 3. 快速回滚
cd /data && rm -rf langgraph_prd && mv langgraph_prd_backup_最新时间戳 langgraph_prd && cd langgraph_prd && ./start.sh

# 4. 联系技术支持并保留现场
```