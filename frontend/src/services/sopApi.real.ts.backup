/**
 * SOP API服务 - 真实API调用，适配统一响应格式
 */

import {
  SOPTemplate,
  SOPTemplateRequest,
  SOPListParams
} from '../types/sop';
import { baseFetchJson } from '../utils/baseFetch';

// 工具函数
export class SOPUtils {
  // 解析步骤JSON字符串
  static parseSteps(stepsJson: string) {
    try {
      return JSON.parse(stepsJson);
    } catch (error) {
      console.error('Failed to parse SOP steps:', error);
      return [];
    }
  }

  // 将步骤数组转换为JSON字符串
  static stringifySteps(steps: any[]): string {
    return JSON.stringify(steps, null, 2);
  }

  // 解析工具JSON字符串
  static parseTools(toolsJson: string): string[] {
    try {
      return JSON.parse(toolsJson);
    } catch (error) {
      console.error('Failed to parse tools:', error);
      return [];
    }
  }

  // 将工具数组转换为JSON字符串
  static stringifyTools(tools: string[]): string {
    return JSON.stringify(tools);
  }
}

/**
 * 处理统一响应格式
 */
function handleUnifiedResponse<T>(response: any): T {
  if (response.status === 'ok') {
    return response.data;
  } else {
    throw new Error(response.msg || '请求失败');
  }
}

// SOP API接口类
export class SOPApi {
  // 获取SOP列表 - 改为GET请求
  static async getSOPs(params: SOPListParams = {}) {
    try {
      const queryParams = new URLSearchParams();
      
      if (params.page) queryParams.append('page', params.page.toString());
      if (params.size) queryParams.append('size', params.size.toString());
      if (params.search) queryParams.append('search', params.search);
      if (params.category) queryParams.append('category', params.category);
      if (params.severity && params.severity !== 'all') queryParams.append('severity', params.severity);
      if (params.team_name) queryParams.append('team_name', params.team_name);

      const url = `/api/v1/sops${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
      const response = await baseFetchJson(url);
      
      return handleUnifiedResponse(response);
    } catch (error) {
      console.error('Failed to fetch SOPs:', error);
      throw error;
    }
  }

  // 获取单个SOP
  static async getSOPById(sopId: string) {
    try {
      const response = await baseFetchJson(`/api/v1/sops/${sopId}`);
      return handleUnifiedResponse<SOPTemplate>(response);
    } catch (error) {
      console.error(`Failed to fetch SOP ${sopId}:`, error);
      throw error;
    }
  }

  // 创建SOP
  static async createSOP(sopData: SOPTemplateRequest) {
    try {
      const response = await baseFetchJson('/api/v1/sops', {
        method: 'POST',
        body: JSON.stringify(sopData),
      });
      return handleUnifiedResponse<SOPTemplate>(response);
    } catch (error) {
      console.error('Failed to create SOP:', error);
      throw error;
    }
  }

  // 更新SOP
  static async updateSOP(sopId: string, sopData: Partial<SOPTemplateRequest>) {
    try {
      const response = await baseFetchJson(`/api/v1/sops/${sopId}`, {
        method: 'PUT',
        body: JSON.stringify(sopData),
      });
      return handleUnifiedResponse<SOPTemplate>(response);
    } catch (error) {
      console.error(`Failed to update SOP ${sopId}:`, error);
      throw error;
    }
  }

  // 删除SOP
  static async deleteSOP(sopId: string) {
    try {
      const response = await baseFetchJson(`/api/v1/sops/${sopId}`, {
        method: 'DELETE',
      });
      return handleUnifiedResponse(response);
    } catch (error) {
      console.error(`Failed to delete SOP ${sopId}:`, error);
      throw error;
    }
  }

  // 获取分类列表
  static async getCategories() {
    try {
      const response = await baseFetchJson('/api/v1/sops/meta/categories');
      return handleUnifiedResponse<string[]>(response);
    } catch (error) {
      console.error('Failed to fetch categories:', error);
      throw error;
    }
  }

  // 获取团队列表
  static async getTeams() {
    try {
      const response = await baseFetchJson('/api/v1/sops/meta/teams');
      return handleUnifiedResponse<string[]>(response);
    } catch (error) {
      console.error('Failed to fetch teams:', error);
      throw error;
    }
  }
}

export default SOPApi;